# PLAN 10-01: R&D Deadline Tracking & Registration Dashboard

## Objective
Build deadline tracking infrastructure and an enhanced R&D registration dashboard that shows registration status, upcoming deadlines, and registration workflow guidance for each financial year.

## Execution Context
- Builds on existing `lib/analysis/rnd-engine.ts` which calculates `registrationDeadline` and `registrationStatus`
- Extends `app/dashboard/forensic-audit/rnd/page.tsx` with new deadline UI
- Uses existing Scientific Luxury design system
- Database: Supabase PostgreSQL

## Context
- Division 355 ITAA 1997 requires R&D registration within 10 months of FY end
- FY2024-25 deadline: 30 April 2026 (3 months away)
- Existing R&D engine already calculates deadlines but doesn't persist registration status
- Users need clear visibility of deadlines and registration progress

## Tasks

### Task 1: Database Schema for R&D Registration Tracking
**Files to create:**
- `lib/supabase/migrations/20260127_rnd_registration.sql`
- `lib/types/rnd-registration.ts`

**Schema:**
```sql
-- R&D Registration tracking per tenant per financial year
CREATE TABLE rnd_registrations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL,
    financial_year TEXT NOT NULL, -- e.g., 'FY2024-25'
    registration_status TEXT NOT NULL DEFAULT 'not_started',
    -- Statuses: not_started, in_progress, submitted, approved, rejected
    ausindustry_reference TEXT, -- AusIndustry registration reference number
    submission_date TIMESTAMPTZ,
    approval_date TIMESTAMPTZ,
    deadline_date DATE NOT NULL, -- 10 months after FY end
    eligible_expenditure DECIMAL(15,2),
    estimated_offset DECIMAL(15,2),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, financial_year)
);

-- Registration deadline reminders
CREATE TABLE rnd_deadline_reminders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL,
    financial_year TEXT NOT NULL,
    reminder_type TEXT NOT NULL, -- '90_days', '60_days', '30_days', '7_days'
    scheduled_date DATE NOT NULL,
    sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**TypeScript types:**
- `RndRegistration` interface
- `RndDeadlineReminder` interface
- `RegistrationStatus` enum
- Helper functions for deadline calculations

### Task 2: R&D Registration API Endpoints
**Files to create:**
- `app/api/rnd/registrations/route.ts` - GET/POST registrations
- `app/api/rnd/registrations/[id]/route.ts` - GET/PATCH/DELETE single registration
- `app/api/rnd/deadlines/route.ts` - GET upcoming deadlines

**Endpoints:**
1. `GET /api/rnd/registrations?tenantId=X` - List all registrations for tenant
2. `POST /api/rnd/registrations` - Create/update registration status
3. `GET /api/rnd/registrations/[id]` - Get single registration details
4. `PATCH /api/rnd/registrations/[id]` - Update registration status/details
5. `GET /api/rnd/deadlines?tenantId=X` - Get upcoming deadlines with urgency levels

### Task 3: Registration Status Dashboard Component
**Files to create:**
- `components/rnd/RegistrationStatusCard.tsx`
- `components/rnd/DeadlineTimeline.tsx`
- `components/rnd/RegistrationWorkflow.tsx`
- `components/rnd/index.ts`

**RegistrationStatusCard:**
- Shows registration status for each FY (colour-coded)
- Displays deadline with days remaining
- Action button to start/continue registration
- AusIndustry reference number when submitted

**DeadlineTimeline:**
- Vertical timeline showing all FYs with deadlines
- Visual markers for: past, approaching (90 days), urgent (30 days)
- Click to expand with registration actions

**RegistrationWorkflow:**
- Step-by-step registration process guide
- Links to AusIndustry portal
- Document checklist before submission

### Task 4: Integrate into R&D Dashboard
**Files to update:**
- `app/dashboard/forensic-audit/rnd/page.tsx`

**Changes:**
- Add "Registration Status" section above projects list
- Show deadline timeline for all FYs with R&D candidates
- Add "Start Registration" button for each eligible FY
- Registration progress indicator (not_started → in_progress → submitted → approved)

### Task 5: Deadline Alert Banner
**Files to create:**
- `components/rnd/DeadlineAlertBanner.tsx`

**Features:**
- Sticky banner at top of R&D pages when deadline < 90 days
- Urgency levels: warning (90 days), urgent (30 days), critical (7 days)
- Dismissible but reappears daily
- Links to registration workflow

## Verification
- [ ] `npm run build` succeeds without errors
- [ ] Registration table created in Supabase
- [ ] API endpoints return correct data
- [ ] Dashboard shows deadline timeline
- [ ] Registration status updates persist
- [ ] Alert banner appears when deadline < 90 days

## Success Criteria
- Users can see all R&D registration deadlines at a glance
- Registration status is tracked per FY
- Urgency is visually clear (colour coding, countdown)
- One-click access to start registration workflow
- Status persists across sessions

## Output
- 1 migration file (SQL)
- 1 types file (TypeScript)
- 4 API route files
- 5 component files
- 1 updated page file
