# PLAN 10-02: R&D Evidence Collection Wizard

## Objective
Build an interactive wizard that guides users through collecting and organizing evidence for each element of the Division 355 four-element test, with document upload integration and evidence sufficiency scoring.

## Execution Context
- Builds on Plan 10-01 registration tracking
- Integrates with existing document upload system from Phase 9
- Uses existing `FourElementTest` interface from `lib/analysis/rnd-engine.ts`
- Scientific Luxury design system

## Context
- Division 355 requires evidence for all four elements: Outcome Unknown, Systematic Approach, New Knowledge, Scientific Method
- Existing R&D engine tracks evidence arrays but doesn't guide collection
- Phase 9 built document upload capability - reuse for R&D evidence
- ATO audits focus heavily on contemporaneous documentation

## Tasks

### Task 1: Evidence Requirements Schema
**Files to create:**
- `lib/supabase/migrations/20260127_rnd_evidence.sql`
- `lib/types/rnd-evidence.ts`

**Schema:**
```sql
-- R&D Evidence items per project per element
CREATE TABLE rnd_evidence (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL,
    registration_id UUID REFERENCES rnd_registrations(id),
    project_name TEXT NOT NULL,
    element TEXT NOT NULL CHECK (element IN (
        'outcome_unknown',
        'systematic_approach',
        'new_knowledge',
        'scientific_method'
    )),
    evidence_type TEXT NOT NULL, -- 'document', 'description', 'reference'
    title TEXT NOT NULL,
    description TEXT,
    document_id UUID, -- Links to recommendation_documents if file uploaded
    url TEXT, -- External URL reference
    date_created DATE, -- When evidence was originally created
    is_contemporaneous BOOLEAN DEFAULT FALSE, -- Created during R&D activity
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Evidence sufficiency scores
CREATE TABLE rnd_evidence_scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL,
    registration_id UUID REFERENCES rnd_registrations(id),
    project_name TEXT NOT NULL,
    outcome_unknown_score INTEGER DEFAULT 0, -- 0-100
    systematic_approach_score INTEGER DEFAULT 0,
    new_knowledge_score INTEGER DEFAULT 0,
    scientific_method_score INTEGER DEFAULT 0,
    overall_score INTEGER DEFAULT 0,
    last_calculated TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, registration_id, project_name)
);
```

**TypeScript types:**
- `RndEvidence` interface
- `RndEvidenceScore` interface
- `EvidenceElement` enum
- Evidence type helpers

### Task 2: Evidence Collection API
**Files to create:**
- `app/api/rnd/evidence/route.ts` - GET/POST evidence items
- `app/api/rnd/evidence/[id]/route.ts` - GET/PATCH/DELETE evidence
- `app/api/rnd/evidence/score/route.ts` - Calculate/GET evidence scores

**Endpoints:**
1. `GET /api/rnd/evidence?tenantId=X&registrationId=Y` - Get all evidence for registration
2. `POST /api/rnd/evidence` - Add evidence item
3. `DELETE /api/rnd/evidence/[id]` - Remove evidence item
4. `GET /api/rnd/evidence/score?tenantId=X&registrationId=Y` - Get evidence sufficiency scores

**Score calculation:**
- Each element scored 0-100 based on:
  - Number of evidence items (0-3 = low, 4-6 = medium, 7+ = high)
  - Document uploads (bonus points)
  - Contemporaneous flag (bonus points)
  - Description quality (text length proxy)
- Overall score = weighted average of four elements

### Task 3: Evidence Wizard Component
**Files to create:**
- `components/rnd/EvidenceWizard.tsx` - Main wizard container
- `components/rnd/EvidenceElementStep.tsx` - Per-element evidence collection
- `components/rnd/EvidenceItem.tsx` - Individual evidence card
- `components/rnd/EvidenceUpload.tsx` - Evidence document upload
- `components/rnd/EvidenceScoreIndicator.tsx` - Visual score display

**EvidenceWizard:**
- Four-step wizard (one per element)
- Progress indicator showing completion
- Navigation between steps
- Save progress automatically
- Final summary with overall score

**EvidenceElementStep:**
- Element name and description
- Guidance text for what evidence to collect
- Example evidence types for this element
- List of added evidence items
- Add evidence button (description, upload, or URL)
- Score indicator for this element

**EvidenceItem:**
- Card showing evidence title, type, date
- Edit/delete actions
- Contemporaneous badge
- Document preview/download if file

**EvidenceScoreIndicator:**
- Circular or bar progress indicator
- Colour-coded: red (0-40), amber (41-70), green (71-100)
- Text label: "Insufficient", "Adequate", "Strong"

### Task 4: Evidence Guidance Content
**Files to create:**
- `lib/rnd/evidence-guidance.ts`

**Content for each element:**
```typescript
const EVIDENCE_GUIDANCE = {
  outcome_unknown: {
    description: "Evidence that the outcome could not be determined in advance",
    examples: [
      "Documentation of knowledge gaps at project start",
      "Records of hypotheses formed before experiments",
      "Technical uncertainties identified in planning documents",
      "Expert opinions on unknowns in the field"
    ],
    suggestedDocuments: [
      "Project initiation document",
      "Technical feasibility study",
      "Literature review showing knowledge gaps",
      "Meeting minutes discussing uncertainties"
    ]
  },
  // ... similar for other elements
}
```

### Task 5: Integrate Wizard into Registration Flow
**Files to update:**
- `app/dashboard/forensic-audit/rnd/page.tsx`
- `components/rnd/RegistrationWorkflow.tsx` (from Plan 10-01)

**New page:**
- `app/dashboard/forensic-audit/rnd/evidence/page.tsx` - Evidence wizard page

**Changes:**
- Add "Collect Evidence" button on each R&D project
- Link from Registration Workflow step 2 to evidence wizard
- Show evidence score on project cards
- Evidence completeness indicator on registration status

## Verification
- [ ] `npm run build` succeeds
- [ ] Evidence tables created in Supabase
- [ ] Wizard navigates through all four elements
- [ ] Evidence items save and persist
- [ ] Document upload works for evidence
- [ ] Scores calculate correctly
- [ ] Scores display on project cards

## Success Criteria
- Users understand what evidence is needed for each element
- Evidence collection is guided with examples
- Documents can be uploaded directly to evidence
- Evidence sufficiency is clearly scored
- Integration with registration workflow is seamless

## Output
- 1 migration file (SQL)
- 1 types file (TypeScript)
- 3 API route files
- 6 component files
- 1 guidance content file
- 1 new page file
- 2 updated files
