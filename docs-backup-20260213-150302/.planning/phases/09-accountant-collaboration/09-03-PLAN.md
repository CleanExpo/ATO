---
phase: 09-accountant-collaboration
plan: 03
type: execute
domain: next-js
---

<objective>
Implement status tracking per recommendation, allowing both owners and accountants to update and track the verification status of each tax finding.

Purpose: Enable clear workflow visibility for which recommendations have been reviewed, approved, or need action.
Output: Status badges on recommendations, status history log, and filtering by status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-accountant-collaboration/09-02-SUMMARY.md

**Builds on Plans 09-01 and 09-02:**
- shared_reports table exists with token-based access
- share_feedback table exists for comments
- AccountantReportView displays findings with feedback

**Status Workflow:**
1. pending_review (default) - Not yet reviewed
2. under_review - Being actively reviewed
3. needs_verification - Requires additional documentation
4. needs_clarification - Questions need answering
5. approved - Accountant has approved
6. rejected - Not valid for claiming
7. implemented - Action taken/claim lodged

**Database Schema Required:**
- New table: `recommendation_status` for tracking
- Fields: id, recommendation_id, share_id, status, updated_by, notes, created_at
</context>

<tasks>

<task type="auto">
  <name>Task 1: Status Database Schema</name>
  <files>lib/supabase/migrations/20260127_recommendation_status.sql, lib/types/recommendation-status.ts</files>
  <action>
Create database infrastructure for status tracking:

1. Create SQL migration for `recommendation_status` table:
   ```sql
   CREATE TABLE recommendation_status (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     recommendation_id TEXT NOT NULL, -- References recommendation.id
     share_id UUID REFERENCES shared_reports(id) ON DELETE CASCADE,
     tenant_id TEXT NOT NULL, -- For owner access without share link
     status TEXT NOT NULL,
     updated_by_name TEXT NOT NULL,
     updated_by_type TEXT NOT NULL, -- 'owner' | 'accountant'
     notes TEXT,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );

   CREATE INDEX idx_rec_status_recommendation ON recommendation_status(recommendation_id);
   CREATE INDEX idx_rec_status_tenant ON recommendation_status(tenant_id);
   ```

2. Create TypeScript types:
   - RecommendationStatus enum with all 7 statuses
   - StatusUpdate interface
   - StatusHistory type (array of updates)
   - STATUS_CONFIG with labels, colours, icons
  </action>
  <verify>
SQL migration syntax valid
Types compile without errors
  </verify>
  <done>
Database table created
Types defined with status config
  </done>
</task>

<task type="auto">
  <name>Task 2: Status API Endpoints</name>
  <files>app/api/recommendations/[id]/status/route.ts, app/api/share/[token]/status/route.ts</files>
  <action>
Create API endpoints for status operations:

1. GET /api/recommendations/[id]/status
   - Return current status and full history
   - Requires tenantId for auth

2. POST /api/recommendations/[id]/status
   - Input: status, notes, updatedByName
   - Requires tenantId for owner access
   - Creates new status record

3. GET /api/share/[token]/status/[recommendationId]
   - Return status for shared report recommendation
   - Token-based access for accountants

4. POST /api/share/[token]/status
   - Input: recommendationId, status, notes, updatedByName
   - Token-based access for accountants
   - Limited to certain status changes (under_review, needs_clarification, approved, rejected)

5. GET /api/recommendations/status-summary?tenantId=xxx
   - Return counts by status across all recommendations
   - For dashboard overview widget
  </action>
  <verify>
Get status returns history
Update status creates record
Token access works for accountants
  </verify>
  <done>
All status endpoints created
Access control working
  </done>
</task>

<task type="auto">
  <name>Task 3: Status UI Components</name>
  <files>components/status/StatusBadge.tsx, components/status/StatusSelector.tsx, components/status/StatusHistory.tsx</files>
  <action>
Create UI components for status display and updates:

1. StatusBadge component:
   - Coloured badge showing current status
   - Icon per status type
   - Tooltip with last update info
   - Compact and expanded variants

2. StatusSelector component:
   - Dropdown to change status
   - Optional notes textarea
   - Confirm button
   - Shows valid transitions only (accountant vs owner)

3. StatusHistory component:
   - Timeline of status changes
   - Who changed it and when
   - Notes displayed inline
   - Collapsible for long histories

4. StatusSummaryCard component:
   - Shows counts per status
   - Progress bar visual
   - Click to filter recommendations
  </action>
  <verify>
Badge displays correctly
Selector shows valid options
History renders timeline
  </verify>
  <done>
All 4 components created
Styling consistent with design system
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Status into Recommendations</name>
  <files>app/dashboard/forensic-audit/recommendations/page.tsx, components/recommendations/RecommendationCard.tsx</files>
  <action>
Add status tracking to owner's recommendations view:

1. Update RecommendationCard (or create if needed):
   - Add StatusBadge to card header
   - Add StatusSelector dropdown
   - Show mini history on hover/click

2. Update recommendations page:
   - Add status filter dropdown
   - Add StatusSummaryCard to page header
   - Fetch status data alongside recommendations
   - Handle status updates inline

3. Add bulk status update:
   - Select multiple recommendations
   - Apply same status to all
   - Useful for marking items as implemented
  </action>
  <verify>
Status badge shows on cards
Filter by status works
Update reflects immediately
  </verify>
  <done>
Recommendations page updated
Status filtering working
Inline updates functional
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate Status into Accountant View</name>
  <files>components/share/AccountantReportView.tsx, app/share/[token]/page.tsx</files>
  <action>
Add status tracking to accountant's shared view:

1. Update AccountantReportView:
   - Add StatusBadge to each finding
   - Add StatusSelector for accountant updates
   - Show status history in expandable section
   - Accountant-specific status options only

2. Update share page:
   - Fetch status for all recommendations on load
   - Handle status updates via share token
   - Refresh status after update
   - Show success toast on status change

3. Add workflow guidance:
   - Suggest next status based on current
   - "Mark as Reviewed" quick action
   - "Request Clarification" with required notes
  </action>
  <verify>
Accountant can see status
Accountant can update limited statuses
Owner sees accountant's updates
  </verify>
  <done>
Accountant view updated
Status sync working
Workflow guidance present
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Owner can set status on recommendations
- [ ] Accountant can update status via share link
- [ ] Status history shows all changes
- [ ] Filter by status works on dashboard
- [ ] Status summary shows correct counts
</verification>

<success_criteria>
- All 5 tasks completed
- Bidirectional status tracking working
- Clear audit trail of status changes
- Dashboard filtering functional
</success_criteria>

<output>
After completion, create `.planning/phases/09-accountant-collaboration/09-03-SUMMARY.md`
</output>
