-- ============================================================================
-- MIGRATION 008: XERO OAuth CONNECTIONS
-- ============================================================================

-- Table to store Xero OAuth tokens and connection metadata
CREATE TABLE IF NOT EXISTS xero_connections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- Xero tenant/organization info
  tenant_id TEXT NOT NULL UNIQUE,
  tenant_name TEXT,
  tenant_type TEXT, -- 'ORGANISATION', 'PRACTICE', etc.

  -- OAuth tokens
  access_token TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  expires_at BIGINT NOT NULL, -- Unix timestamp in milliseconds
  id_token TEXT,
  scope TEXT,
  token_type TEXT DEFAULT 'Bearer',

  -- Connection metadata
  connected_at TIMESTAMPTZ DEFAULT NOW(),
  last_refreshed_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- User association (optional - for multi-user systems)
  user_id UUID, -- Reference to auth.users if using Supabase Auth
  user_email TEXT,

  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  connection_status TEXT DEFAULT 'active', -- 'active', 'expired', 'revoked', 'error'
  last_error TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for fast tenant lookups
CREATE INDEX IF NOT EXISTS idx_xero_connections_tenant
  ON xero_connections(tenant_id);

-- Index for active connections
CREATE INDEX IF NOT EXISTS idx_xero_connections_active
  ON xero_connections(is_active, connection_status)
  WHERE is_active = TRUE;

-- Index for user associations
CREATE INDEX IF NOT EXISTS idx_xero_connections_user
  ON xero_connections(user_id)
  WHERE user_id IS NOT NULL;

-- Function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_xero_connections_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-update updated_at
CREATE TRIGGER trigger_xero_connections_updated_at
  BEFORE UPDATE ON xero_connections
  FOR EACH ROW
  EXECUTE FUNCTION update_xero_connections_updated_at();

-- Success message
SELECT 'Migration 008 Complete: xero_connections table created!' as status;
