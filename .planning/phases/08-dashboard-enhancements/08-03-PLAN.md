---
phase: 08-dashboard-enhancements
plan: 03
type: execute
domain: next-js
---

<objective>
Enhance the analysis progress display with better real-time feedback, batch completion notifications, and estimated time remaining.

Purpose: Improve user confidence during long-running analysis by showing detailed progress information.
Output: Enhanced progress UI on forensic-audit page with live updates and time estimates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@D:/ATO/app/dashboard/forensic-audit/page.tsx
@D:/ATO/components/dashboard/LiveProgressCard.tsx

**Current Implementation:**
- Uses 5-second polling interval
- Shows sync progress and analysis progress separately
- Basic progress bar with percentage

**Enhancement Goals:**
- Show batch-level progress (e.g., "Batch 45 of 200")
- Estimated time remaining based on batch completion rate
- Show recent batch results (last 5 batches)
- Visual confidence that process is working
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Enhanced Progress Component</name>
  <files>components/forensic-audit/AnalysisProgressPanel.tsx</files>
  <action>
Create a detailed progress panel component:

1. Overall progress section:
   - Large circular progress indicator (ring style)
   - Percentage in center with animation
   - Stage label below (Syncing / Analysing / Complete)

2. Batch progress section:
   - "Batch 45 of 200" with mini progress bar
   - Transactions in current batch: "Processing 5 transactions..."
   - Success/failure count for current batch

3. Time estimates:
   - "Started: 14:32:05"
   - "Elapsed: 12m 34s"
   - "Estimated remaining: ~8m"
   - Calculate from average batch time × remaining batches

4. Recent activity feed (last 5 batches):
   - Timestamp + batch number + result
   - e.g., "14:43:21 - Batch 44 complete (5/5 analysed)"
   - Scrollable list with newest at top

5. Live statistics strip:
   - Total analysed: 1,234
   - R&D candidates found: 45
   - Deductions identified: $123,456
   - Updates in real-time as batches complete

Use framer-motion for number animations (AnimatedCounter style).
SPECTRAL.cyan for progress ring, SPECTRAL.emerald for success indicators.
  </action>
  <verify>
Component renders with mock data
Progress ring animates smoothly
Activity feed shows batch history
  </verify>
  <done>
AnalysisProgressPanel component created
All sections render correctly
Animations smooth and performant
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Progress State Management</name>
  <files>lib/hooks/useAnalysisProgress.ts, app/api/audit/analysis-status/[tenantId]/route.ts</files>
  <action>
Create a custom hook for progress tracking:

1. Create lib/hooks/useAnalysisProgress.ts:
   - useAnalysisProgress(tenantId) hook
   - Manages polling interval (2s during active, 10s when idle)
   - Tracks batch history (last 10 batches)
   - Calculates estimated time remaining
   - Returns:
     ```typescript
     {
       stage: 'idle' | 'syncing' | 'analyzing' | 'complete' | 'error'
       overallProgress: number // 0-100
       currentBatch: { number: number, total: number, transactions: number }
       timeEstimate: { elapsed: number, remaining: number | null }
       stats: { analyzed: number, rndCandidates: number, totalDeductions: number }
       recentBatches: Array<{ timestamp: Date, batch: number, analyzed: number, success: boolean }>
       error: string | null
     }
     ```

2. Enhance app/api/audit/analysis-status/[tenantId]/route.ts:
   - Add batchNumber, totalBatches to response
   - Add lastBatchTime, averageBatchTime
   - Add interim statistics (R&D count, deduction total)
   - Query forensic_analysis_results for live counts

3. Calculate time estimates:
   - Track batch completion times
   - Use rolling average of last 5 batches
   - Multiply by remaining batches
   - Add buffer for uncertainty (±20%)
  </action>
  <verify>
Hook returns correct state during analysis
Polling interval adjusts based on stage
Time estimates update as batches complete
  </verify>
  <done>
useAnalysisProgress hook created and tested
API returns enhanced progress data
Time estimates reasonably accurate
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Enhanced Progress into Forensic Audit Page</name>
  <files>app/dashboard/forensic-audit/page.tsx</files>
  <action>
Update the forensic audit page to use enhanced progress:

1. Replace inline progress logic with useAnalysisProgress hook

2. Replace Node 2 (PROCESS) content:
   - When syncing: Show sync progress with transaction count
   - When analyzing: Show AnalysisProgressPanel component
   - Panel positioned to the right of the node marker
   - Smooth transition between states

3. Add floating progress card option:
   - Button "Minimize Progress" → collapses to small floating indicator
   - Shows mini circular progress + ETA
   - Click to expand back

4. Add notification when complete:
   - Browser notification (if permitted)
   - Sound cue (optional, toggle in settings)
   - Toast notification with summary

5. Preserve background operation indicator:
   - "Process runs in background. Safe to navigate away."
   - Add: "Last update: 5s ago" to show polling is working

6. Handle edge cases:
   - Very long analyses (>1 hour): Show "This is taking longer than usual"
   - Stalled batches: Detect if no progress for 2 minutes, show warning
   - Rate limit hits: Show "Waiting for rate limit reset..." message
  </action>
  <verify>
Progress panel appears during analysis
Time estimates shown and update
Navigate away and back - progress preserved
Complete notification triggers
  </verify>
  <done>
Enhanced progress integrated into page
All progress states handled correctly
Edge cases show appropriate messages
User experience significantly improved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Progress panel shows during analysis
- [ ] Batch progress updates in real-time
- [ ] Time estimates reasonably accurate (within 50% of actual)
- [ ] Recent activity feed populates correctly
- [ ] Edge cases handled (stalled, rate-limited)
- [ ] Navigation away and back preserves progress state
</verification>

<success_criteria>
- All 3 tasks completed
- Progress information significantly more detailed than before
- Time estimates help user plan their time
- No regression in existing functionality
- Matches Scientific Luxury design system
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-enhancements/08-03-SUMMARY.md`
</output>
