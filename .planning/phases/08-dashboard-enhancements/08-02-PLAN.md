---
phase: 08-dashboard-enhancements
plan: 02
type: execute
domain: next-js
---

<objective>
Add direct export functionality to the dashboard UI, allowing users to download Excel and PDF reports without using external scripts.

Purpose: Enable one-click export of analysis results in accountant-friendly formats directly from the browser.
Output: Export buttons on recommendations and transactions pages that generate downloadable Excel/PDF files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@D:/ATO/app/api/audit/reports/generate/route.ts
@D:/ATO/lib/reports/excel-generator.ts
@D:/ATO/lib/reports/pdf-generator.ts
@D:/ATO/components/operations/ReportDownloadButton.tsx

**Tech Stack Available:**
- exceljs for Excel generation (already in package.json)
- puppeteer for PDF generation (already in package.json)
- archiver for ZIP creation (already in package.json)

**Existing Infrastructure:**
- POST /api/audit/reports/generate - generates reports (pdf, excel, amendments, all)
- lib/reports/excel-generator.ts - Excel workbook generation
- lib/reports/pdf-generator.ts - PDF HTML generation
- ReportDownloadButton component exists

**Design Tokens:**
- SPECTRAL colours for buttons
- Scientific Luxury styling patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Export Modal Component</name>
  <files>components/forensic-audit/ExportModal.tsx</files>
  <action>
Create a reusable export modal component:

1. Modal overlay with OLED black background (rgba(0,0,0,0.9))
2. Export options:
   - Format selection: Excel (.xlsx), PDF, CSV ZIP, All Formats
   - Scope selection: All Transactions, Current Filter, Selected Only
   - Include options (checkboxes):
     - [ ] R&D Candidates
     - [ ] High Value Deductions (>$500)
     - [ ] FBT Review Items
     - [ ] Division 7A Items
     - [ ] Summary Statistics
3. Organisation details (pre-filled from tenant):
   - Organisation name input
   - ABN input
4. Export button with loading state (BreathingOrb)
5. Progress indicator for large exports
6. Close button (X) and click-outside-to-close

Use framer-motion for modal entrance/exit animation.
Style with Scientific Luxury design system.
Accept props: isOpen, onClose, tenantId, selectedTransactionIds?, currentFilters?
  </action>
  <verify>
Component renders when isOpen=true
All form controls functional
Modal closes on X or click outside
  </verify>
  <done>
ExportModal component created with all options
Styling matches Scientific Luxury design
Form state management working
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Export API Client</name>
  <files>lib/api/export-client.ts, app/api/audit/reports/download/route.ts</files>
  <action>
Create client-side export functionality:

1. Create lib/api/export-client.ts:
   - exportToExcel(tenantId, options) - calls API, returns blob
   - exportToPDF(tenantId, options) - calls API, returns blob
   - exportToCSVZip(tenantId, options) - calls API, returns blob
   - downloadBlob(blob, filename) - triggers browser download

2. Update/create app/api/audit/reports/download/route.ts:
   - Accept POST with format and options
   - Generate report using existing generators
   - Return appropriate Content-Type headers:
     - Excel: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
     - PDF: application/pdf
     - ZIP: application/zip
   - Stream large files instead of buffering

3. Handle errors gracefully:
   - Show toast notification on failure
   - Retry logic for transient failures

Options interface:
```typescript
interface ExportOptions {
  format: 'excel' | 'pdf' | 'csv-zip' | 'all'
  scope: 'all' | 'filtered' | 'selected'
  filters?: {
    financialYear?: string
    isRndCandidate?: boolean
    primaryCategory?: string
    minConfidence?: number
  }
  selectedIds?: string[]
  include: {
    rndCandidates: boolean
    highValueDeductions: boolean
    fbtItems: boolean
    div7aItems: boolean
    summaryStats: boolean
  }
  organizationName: string
  abn: string
}
```
  </action>
  <verify>
API returns correct file types with proper headers
Client functions trigger browser download
Large exports (10k+ rows) complete successfully
  </verify>
  <done>
Export client library created
API endpoint returns downloadable files
Browser download triggered successfully
Error handling with user feedback
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Export Buttons to Pages</name>
  <files>app/dashboard/forensic-audit/recommendations/page.tsx, app/dashboard/forensic-audit/transactions/page.tsx</files>
  <action>
Integrate export functionality into existing pages:

1. Add export button to Recommendations page:
   - Place in Xero Integration section
   - Opens ExportModal
   - Pre-selects "All Recommendations" scope

2. Add export button to Transactions page (from Plan 08-01):
   - Place in page header/toolbar area
   - Shows "Export (N selected)" when rows selected
   - Opens ExportModal with:
     - Current filters pre-applied
     - Selected transaction IDs if any

3. Add quick export dropdown for common exports:
   - "Quick Export" button with dropdown:
     - Download All as Excel
     - Download R&D Report (PDF)
     - Download Accountant Package (ZIP)
   - Bypasses modal for one-click export

4. Show export progress toast:
   - "Generating Excel report..."
   - "Download starting..."
   - Error messages if failed

5. Track export in state to prevent duplicate requests
  </action>
  <verify>
Export button visible on both pages
Modal opens with correct pre-selections
Quick export downloads correct file format
Progress shown during generation
  </verify>
  <done>
Export buttons integrated on both pages
Modal opens and generates reports
Quick export dropdown functional
Toast notifications working
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Excel export downloads valid .xlsx file
- [ ] PDF export downloads valid PDF with styling
- [ ] CSV ZIP contains all expected files
- [ ] Export respects current filters
- [ ] Selected-only export works correctly
- [ ] Large exports (10k+ transactions) complete without timeout
</verification>

<success_criteria>
- All 3 tasks completed
- Export modal matches Scientific Luxury design
- All export formats generate valid files
- Performance acceptable for 10,000+ transactions
- Error handling provides clear feedback
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-enhancements/08-02-SUMMARY.md`
</output>
