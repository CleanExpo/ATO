---
phase: 09-accountant-collaboration
plan: 01
type: execute
domain: next-js
---

<objective>
Create secure report sharing infrastructure allowing accountants to access analysis results via time-limited shareable links without requiring Xero authentication.

Purpose: Enable collaboration between business owners and their accountants by providing secure, read-only access to tax analysis reports.
Output: Shareable link generation UI, secure token-based access, and accountant-view pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@D:/ATO/app/api/audit/reports/generate/route.ts
@D:/ATO/app/dashboard/forensic-audit/recommendations/page.tsx

**Database Schema Required:**
- New table: `shared_reports` for tracking share links
- Fields: id, tenant_id, token, expires_at, created_by, access_count, last_accessed

**Security Requirements:**
- Time-limited tokens (default 7 days)
- Read-only access
- IP logging for audit trail
- Revocable links
- No authentication required (token-based access)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Schema for Shared Reports</name>
  <files>lib/supabase/migrations/shared_reports.sql, lib/types/shared-reports.ts</files>
  <action>
Create database infrastructure for shared reports:

1. Create SQL migration for `shared_reports` table:
   ```sql
   CREATE TABLE shared_reports (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     tenant_id TEXT NOT NULL,
     token TEXT UNIQUE NOT NULL,
     title TEXT NOT NULL,
     description TEXT,
     report_type TEXT NOT NULL, -- 'full' | 'rnd' | 'deductions' | 'custom'
     filters JSONB, -- Optional filters applied to the report
     created_by TEXT, -- User who created the link
     created_at TIMESTAMPTZ DEFAULT NOW(),
     expires_at TIMESTAMPTZ NOT NULL,
     is_revoked BOOLEAN DEFAULT FALSE,
     access_count INTEGER DEFAULT 0,
     last_accessed_at TIMESTAMPTZ,
     last_accessed_ip TEXT,
     password_hash TEXT -- Optional password protection
   );

   CREATE INDEX idx_shared_reports_token ON shared_reports(token);
   CREATE INDEX idx_shared_reports_tenant ON shared_reports(tenant_id);
   ```

2. Create TypeScript types in lib/types/shared-reports.ts:
   - SharedReport interface
   - CreateShareLinkRequest type
   - ShareLinkResponse type
   - AccessLogEntry type

3. Generate secure token function:
   - 32-character alphanumeric + special chars
   - Cryptographically random
   - URL-safe encoding
  </action>
  <verify>
SQL migration runs successfully
Types compile without errors
Token generation produces unique values
  </verify>
  <done>
Database table created
Types defined
Token generation working
  </done>
</task>

<task type="auto">
  <name>Task 2: Share Link API Endpoints</name>
  <files>app/api/share/create/route.ts, app/api/share/[token]/route.ts, app/api/share/revoke/route.ts</files>
  <action>
Create API endpoints for managing share links:

1. POST /api/share/create
   - Input: tenantId, reportType, title, expiresInDays, password?
   - Generate unique token
   - Create database record
   - Return: { token, shareUrl, expiresAt }

2. GET /api/share/[token]
   - Validate token exists and not expired/revoked
   - Increment access count
   - Log access IP and timestamp
   - Return report data based on reportType
   - If password protected, require password header

3. POST /api/share/revoke
   - Input: token or shareId
   - Mark as revoked in database
   - Return success/failure

4. GET /api/share/list?tenantId=xxx
   - List all active share links for tenant
   - Include access statistics

All endpoints should:
- Use proper error handling from lib/api/errors
- Validate inputs
- Log access for audit trail
  </action>
  <verify>
Create endpoint generates valid token
Access endpoint returns report data
Revoke endpoint disables access
Expired tokens rejected
  </verify>
  <done>
All 4 API endpoints created
Token validation working
Access logging functional
  </done>
</task>

<task type="auto">
  <name>Task 3: Share Link UI Components</name>
  <files>components/share/CreateShareModal.tsx, components/share/ShareLinkManager.tsx, components/share/ShareLinkCard.tsx</files>
  <action>
Create UI components for managing share links:

1. CreateShareModal component:
   - Report type selector (Full Report, R&D Only, Deductions Only, Custom)
   - Expiry selector (24 hours, 7 days, 30 days, Custom date)
   - Optional password protection checkbox + input
   - Title and description inputs
   - Generate button
   - Copy link button with success feedback
   - Scientific Luxury design

2. ShareLinkManager component:
   - List of active share links
   - Filter by status (active, expired, revoked)
   - Sort by created date, access count
   - Bulk revoke capability

3. ShareLinkCard component:
   - Shows: title, report type, expires date, access count
   - Copy link button
   - Revoke button with confirmation
   - QR code generation option
   - Status badge (active/expired/revoked)
  </action>
  <verify>
Modal opens and closes correctly
Form validation works
Link generation and copying works
Manager lists links correctly
  </verify>
  <done>
All 3 components created
Modal form functional
Manager displays links
  </done>
</task>

<task type="auto">
  <name>Task 4: Accountant View Pages</name>
  <files>app/share/[token]/page.tsx, app/share/[token]/layout.tsx, components/share/AccountantReportView.tsx</files>
  <action>
Create public-facing pages for accountants:

1. Create app/share/[token]/layout.tsx:
   - Minimal layout without auth requirements
   - Custom header with "Shared Report" branding
   - Footer with "Powered by ATO Tax Optimizer"

2. Create app/share/[token]/page.tsx:
   - Fetch report data using token
   - Handle expired/revoked/invalid states
   - Password entry if required
   - Loading state while fetching

3. Create AccountantReportView component:
   - Executive summary section
   - Key metrics display
   - Recommendations list (read-only)
   - Transaction samples
   - Export to PDF button
   - Print-friendly styling
   - "Last updated" timestamp
   - Organisation name display

4. Error states:
   - Invalid token: "This link is invalid or has been removed"
   - Expired: "This link has expired. Please request a new one."
   - Revoked: "Access to this report has been revoked."
   - Password required: Password entry form
  </action>
  <verify>
Valid token shows report
Expired token shows appropriate message
Revoked token denied
Password protection works
Export/print functions work
  </verify>
  <done>
Share pages created
Accountant view displays correctly
All error states handled
Export functional
  </done>
</task>

<task type="auto">
  <name>Task 5: Integration with Existing Pages</name>
  <files>app/dashboard/forensic-audit/recommendations/page.tsx</files>
  <action>
Add share functionality to existing pages:

1. Add "Share Report" button to Recommendations page header:
   - Opens CreateShareModal
   - Pre-selects "Full Report" type

2. Add share buttons to individual recommendation cards:
   - "Share This Finding" option
   - Creates link filtered to that specific recommendation

3. Add "Manage Shared Links" link to Xero Integration section:
   - Opens ShareLinkManager in modal or navigates to management page

4. Update forensic-audit main page:
   - Add "Share" option next to export buttons
  </action>
  <verify>
Share button visible on recommendations page
Modal opens with correct defaults
Individual recommendation sharing works
Links navigate to manager
  </verify>
  <done>
Share buttons integrated
Modal integration working
Navigation to manager working
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Create share link generates unique token
- [ ] Share URL accessible without authentication
- [ ] Expired links show appropriate message
- [ ] Revoked links denied access
- [ ] Password protection works correctly
- [ ] Access logging captures IP and timestamp
- [ ] Accountant view displays report data correctly
- [ ] Export from accountant view works
</verification>

<success_criteria>
- All 5 tasks completed
- Share links work without Xero auth
- Security measures in place (expiry, revocation, password)
- Accountant view is professional and complete
- Integration with existing pages seamless
</success_criteria>

<output>
After completion, create `.planning/phases/09-accountant-collaboration/09-01-SUMMARY.md`
</output>
