---
phase: 09-accountant-collaboration
plan: 04
type: execute
domain: next-js
---

<objective>
Implement document upload capability allowing accountants to attach supporting documentation to recommendations for verification purposes.

Purpose: Enable accountants to provide evidence, receipts, and supporting documents directly through the share portal.
Output: Document upload UI, secure storage, download capability, and document list per recommendation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-accountant-collaboration/09-03-SUMMARY.md

**Builds on Plans 09-01, 09-02, 09-03:**
- shared_reports table exists with token-based access
- share_feedback table exists for comments
- recommendation_status table exists for tracking
- AccountantReportView displays findings with feedback and status

**Document Types Expected:**
- Tax invoices and receipts
- Bank statements
- Contracts and agreements
- R&D project documentation
- Share registers (for COT verification)
- Loan agreements (for Div 7A)
- Evidence of payment

**Storage Approach:**
- Supabase Storage for file storage
- Database table for metadata (filename, size, type, uploader)
- Secure signed URLs for downloads
- Max file size: 10MB per file
- Allowed types: PDF, images (jpg, png), documents (doc, docx, xls, xlsx)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document Storage Schema</name>
  <files>lib/supabase/migrations/20260127_recommendation_documents.sql, lib/types/recommendation-documents.ts</files>
  <action>
Create database infrastructure for document storage:

1. Create SQL migration for `recommendation_documents` table:
   ```sql
   CREATE TABLE recommendation_documents (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     recommendation_id TEXT NOT NULL,
     share_id UUID REFERENCES shared_reports(id) ON DELETE SET NULL,
     tenant_id TEXT NOT NULL,
     file_name TEXT NOT NULL,
     file_size INTEGER NOT NULL,
     file_type TEXT NOT NULL,
     storage_path TEXT NOT NULL,
     uploaded_by_name TEXT NOT NULL,
     uploaded_by_type TEXT NOT NULL, -- 'owner' | 'accountant'
     description TEXT,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );

   CREATE INDEX idx_rec_docs_recommendation ON recommendation_documents(recommendation_id);
   CREATE INDEX idx_rec_docs_tenant ON recommendation_documents(tenant_id);
   ```

2. Create TypeScript types:
   - RecommendationDocument interface
   - DocumentUploadRequest type
   - DocumentListResponse type
   - ALLOWED_FILE_TYPES constant
   - MAX_FILE_SIZE constant (10MB)
  </action>
  <verify>
SQL migration syntax valid
Types compile without errors
  </verify>
  <done>
Database table created
Types defined with constants
  </done>
</task>

<task type="auto">
  <name>Task 2: Document API Endpoints</name>
  <files>app/api/recommendations/[id]/documents/route.ts, app/api/share/[token]/documents/route.ts</files>
  <action>
Create API endpoints for document operations:

1. POST /api/recommendations/[id]/documents
   - Owner upload via tenantId auth
   - Accept multipart form data
   - Validate file type and size
   - Upload to Supabase Storage
   - Create metadata record

2. GET /api/recommendations/[id]/documents
   - Return document list for recommendation
   - Include signed download URLs
   - Requires tenantId for auth

3. DELETE /api/recommendations/[id]/documents/[docId]
   - Owner can delete any document
   - Remove from storage and database

4. POST /api/share/[token]/documents
   - Accountant upload via share token
   - Same validation as owner endpoint
   - Mark uploaded_by_type as 'accountant'

5. GET /api/share/[token]/documents?recommendationId=xxx
   - Return documents for shared recommendation
   - Token-based access for accountants
  </action>
  <verify>
Upload creates file in storage
Download URL works
Delete removes file
Token access works for accountants
  </verify>
  <done>
All document endpoints created
File validation working
  </done>
</task>

<task type="auto">
  <name>Task 3: Document UI Components</name>
  <files>components/documents/DocumentUpload.tsx, components/documents/DocumentList.tsx, components/documents/DocumentCard.tsx, components/documents/index.ts</files>
  <action>
Create UI components for document management:

1. DocumentUpload component:
   - Drag-and-drop zone
   - File type validation with feedback
   - Upload progress indicator
   - Optional description field
   - Success/error states

2. DocumentList component:
   - Grid or list view of documents
   - Sortable by date, name, type
   - Filter by document type
   - Bulk selection for download

3. DocumentCard component:
   - File icon based on type
   - Filename and size display
   - Upload date and uploader
   - Download button
   - Delete button (owner only)
   - Description tooltip

4. DocumentPreview component (optional):
   - Inline preview for images
   - PDF viewer integration
   - "Open in new tab" fallback
  </action>
  <verify>
Upload UI shows progress
List displays documents
Download works
  </verify>
  <done>
All 4 components created
Styling consistent with design system
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Documents into Recommendations</name>
  <files>app/dashboard/forensic-audit/recommendations/page.tsx, components/forensic-audit/ExpandableRecommendationCard.tsx</files>
  <action>
Add document management to owner's recommendations view:

1. Update ExpandableRecommendationCard:
   - Add "Documents" tab or section
   - Show document count badge
   - Include DocumentList component
   - Include DocumentUpload component
   - Handle upload callbacks

2. Update recommendations page:
   - Fetch document counts with recommendations
   - Pass document handlers to cards
   - Show toast on upload success/failure

3. Add document indicator:
   - Badge showing document count on collapsed card
   - Icon indicating documents attached
  </action>
  <verify>
Documents section visible in card
Upload works from card
Document count shows correctly
  </verify>
  <done>
Recommendations page updated
Document management functional
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate Documents into Accountant View</name>
  <files>components/share/AccountantReportView.tsx, app/share/[token]/page.tsx</files>
  <action>
Add document management to accountant's shared view:

1. Update AccountantReportView:
   - Add documents section to each finding
   - Show existing documents (uploaded by owner)
   - Include DocumentUpload for accountant
   - Include DocumentList with download links

2. Update share page:
   - Fetch documents for all recommendations on load
   - Handle document upload via share token
   - Refresh document list after upload

3. Add upload guidance:
   - Suggested document types per recommendation category
   - "Required for verification" indicator
   - Help text explaining what to upload
  </action>
  <verify>
Accountant can see owner documents
Accountant can upload documents
Owner sees accountant uploads
  </verify>
  <done>
Accountant view updated
Document sync working
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Owner can upload documents to recommendations
- [ ] Accountant can upload documents via share link
- [ ] Documents appear in both views
- [ ] Download works for all document types
- [ ] File validation prevents invalid uploads
</verification>

<success_criteria>
- All 5 tasks completed
- Bidirectional document sharing working
- File storage secure with signed URLs
- Document list displays correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-accountant-collaboration/09-04-SUMMARY.md`
</output>
