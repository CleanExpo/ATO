---
phase: 09-accountant-collaboration
plan: 02
type: execute
domain: next-js
---

<objective>
Implement accountant feedback system allowing accountants to leave comments, questions, and status updates on shared reports without requiring authentication.

Purpose: Enable two-way communication between business owners and accountants for efficient verification and clarification of tax findings.
Output: Comment threads on findings, notification system, and feedback management UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-accountant-collaboration/09-01-SUMMARY.md

**Builds on Plan 09-01:**
- shared_reports table exists
- Token-based access working
- AccountantReportView component exists

**Database Schema Required:**
- New table: `share_feedback` for comments/questions
- Fields: id, share_id, author_name, author_email, message, finding_id, created_at, is_read
</context>

<tasks>

<task type="auto">
  <name>Task 1: Feedback Database Schema</name>
  <files>lib/supabase/migrations/20260127_share_feedback.sql, lib/types/share-feedback.ts</files>
  <action>
Create database infrastructure for feedback:

1. Create SQL migration for `share_feedback` table:
   ```sql
   CREATE TABLE share_feedback (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     share_id UUID NOT NULL REFERENCES shared_reports(id) ON DELETE CASCADE,
     finding_id TEXT, -- Optional: links to specific finding
     author_name TEXT NOT NULL,
     author_email TEXT,
     message TEXT NOT NULL,
     feedback_type TEXT NOT NULL, -- 'comment' | 'question' | 'approval' | 'concern'
     created_at TIMESTAMPTZ DEFAULT NOW(),
     is_read BOOLEAN DEFAULT FALSE,
     read_at TIMESTAMPTZ,
     reply_to UUID REFERENCES share_feedback(id) -- For threaded replies
   );
   ```

2. Create TypeScript types:
   - ShareFeedback interface
   - CreateFeedbackRequest type
   - FeedbackThread type (grouped by finding)
  </action>
  <verify>
SQL migration syntax valid
Types compile without errors
  </verify>
  <done>
Database table created
Types defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Feedback API Endpoints</name>
  <files>app/api/share/[token]/feedback/route.ts, app/api/share/feedback/[id]/read/route.ts</files>
  <action>
Create API endpoints for feedback:

1. POST /api/share/[token]/feedback
   - Input: author_name, author_email?, message, feedback_type, finding_id?
   - Validate token is valid and not expired
   - Create feedback record
   - Return: created feedback with id

2. GET /api/share/[token]/feedback
   - Return all feedback for this share link
   - Group by finding_id for threaded display
   - Include reply threads

3. POST /api/share/feedback/[id]/read
   - Mark feedback as read
   - Set read_at timestamp
   - For owner use (authenticated)

4. GET /api/share/feedback/unread?tenantId=xxx
   - Get unread feedback count for all share links
   - For dashboard notification badge
  </action>
  <verify>
Create feedback works
List feedback returns grouped data
Mark as read updates correctly
  </verify>
  <done>
All feedback endpoints created
Token validation working
  </done>
</task>

<task type="auto">
  <name>Task 3: Feedback UI Components</name>
  <files>components/share/FeedbackThread.tsx, components/share/FeedbackForm.tsx, components/share/FeedbackBadge.tsx</files>
  <action>
Create UI components for feedback:

1. FeedbackForm component:
   - Name input (required)
   - Email input (optional)
   - Message textarea
   - Feedback type selector (Comment, Question, Approval, Concern)
   - Submit button
   - Inline success message

2. FeedbackThread component:
   - List of feedback items
   - Grouped by finding
   - Reply button for threaded responses
   - Timestamp display
   - Type-based styling (question = blue, concern = amber, etc.)

3. FeedbackBadge component:
   - Unread count display
   - Animated when new feedback
   - For use on share link cards
  </action>
  <verify>
Form validates required fields
Thread displays correctly
Badge shows count
  </verify>
  <done>
All 3 components created
Form submission works
Thread grouping correct
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Feedback into Accountant View</name>
  <files>components/share/AccountantReportView.tsx, app/share/[token]/page.tsx</files>
  <action>
Add feedback capability to accountant view:

1. Update AccountantReportView:
   - Add feedback section at bottom of each finding card
   - "Leave Feedback" button expands FeedbackForm
   - Show existing feedback thread if any
   - General feedback section for overall report comments

2. Update share page:
   - Fetch existing feedback on load
   - Pass feedback data to AccountantReportView
   - Handle new feedback submission
   - Show success toast on submission

3. Add feedback indicator to findings:
   - Badge showing feedback count per finding
   - Different colours for questions vs comments
  </action>
  <verify>
Feedback form appears on findings
Existing feedback displayed
New feedback submits correctly
  </verify>
  <done>
Accountant view updated
Feedback integrated
Submission working
  </done>
</task>

<task type="auto">
  <name>Task 5: Owner Feedback Management</name>
  <files>app/dashboard/forensic-audit/shared-links/page.tsx, components/share/ShareLinkCard.tsx</files>
  <action>
Add feedback management for report owners:

1. Update ShareLinkCard:
   - Add FeedbackBadge showing unread count
   - Click to expand feedback list
   - Mark as read functionality

2. Update shared-links page:
   - Fetch unread feedback counts
   - Filter by "Has Feedback" option
   - Notification summary at top

3. Create FeedbackManagement section:
   - List all feedback across all share links
   - Sort by date, filter by type
   - Mark all as read button
   - Quick reply capability (creates new share or email link)
  </action>
  <verify>
Badge shows correct count
Feedback list displays
Mark as read works
  </verify>
  <done>
Owner can see feedback
Badge counts accurate
Management interface complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Accountant can submit feedback on shared report
- [ ] Feedback appears immediately after submission
- [ ] Owner sees unread feedback badge
- [ ] Mark as read updates status
- [ ] Feedback threads group by finding
</verification>

<success_criteria>
- All 5 tasks completed
- Two-way feedback flow working
- No authentication required for accountant feedback
- Owner notified of new feedback
</success_criteria>

<output>
After completion, create `.planning/phases/09-accountant-collaboration/09-02-SUMMARY.md`
</output>
